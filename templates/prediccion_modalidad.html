{% extends "base.html" %}

{% block title %}Predicción 2026 - {{ modalidad }}{% endblock %}

{% block content %}

<h1 class="mb-3">Predicción 2026 para la modalidad: {{ modalidad }}</h1>

{% if sin_datos %}
    <div class="alert alert-warning">
        No se encontraron datos históricos suficientes para la modalidad
        <strong>{{ modalidad }}</strong>. No es posible generar una predicción.
    </div>
{% else %}

<p class="text-muted">
    El modelo utiliza una regresión lineal sobre la serie mensual histórica de
    <strong>{{ modalidad }}</strong> para estimar el número de denuncias en el
    periodo de julio a diciembre de 2026.
</p>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title">RMSE</h5>
                <p class="card-text display-6">
                    {% if rmse is not none %}
                        {{ "%.2f"|format(rmse) }}
                    {% else %}
                        No calculado
                    {% endif %}
                </p>
                <p class="text-muted">Error cuadrático medio sobre los últimos meses históricos.</p>
            </div>
        </div>
    </div>
    <div class="col-md-6 mt-3 mt-md-0">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title">R²</h5>
                <p class="card-text display-6">
                    {% if r2 is not none %}
                        {{ "%.3f"|format(r2) }}
                    {% else %}
                        No calculado
                    {% endif %}
                </p>
                <p class="text-muted">Porcentaje de variabilidad explicado por el modelo.</p>
            </div>
        </div>
    </div>
</div>

<div class="card mb-4 shadow-sm">
    <div class="card-body">
        <h5 class="card-title">Histórico vs predicción 2026 ({{ modalidad }})</h5>
        <canvas id="graficoPredModalidad"></canvas>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-body">
        <h5 class="card-title">Predicciones julio–diciembre 2026</h5>
        <table class="table table-striped table-sm">
            <thead>
            <tr>
                <th>Mes</th>
                <th>Predicción de denuncias</th>
            </tr>
            </thead>
            <tbody>
            {% for fila in tabla_pred %}
                <tr>
                    <td>{{ fila.label }}</td>
                    <td>{{ fila.prediccion }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    const ctx = document.getElementById('graficoPredModalidad');

    const labelsHist = {{ labels_hist|tojson }};
    const valoresHist = {{ valores_hist|tojson }};
    const labelsPred = {{ labels_pred|tojson }};
    const valoresPred = {{ valores_pred|tojson }};

    const allLabels = labelsHist.concat(labelsPred);
    const paddingNulls = Array(valoresHist.length).fill(null);
    const predSeries = paddingNulls.concat(valoresPred);

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: allLabels,
            datasets: [
                {
                    label: 'Histórico',
                    data: valoresHist,
                    borderWidth: 2
                },
                {
                    label: 'Predicción 2026 (jul–dic)',
                    data: predSeries,
                    borderWidth: 2,
                    borderDash: [5, 5]
                }
            ]
        },
        options: {
            plugins: {
                legend: { display: true }
            }
        }
    });
</script>

{% endif %}

{% endblock %}
