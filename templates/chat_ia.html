{% extends "base.html" %}

{% block title %}Asistente IA - SIDPOL{% endblock %}

{% block content %}
<style>
    /* --- ESTILOS EXCLUSIVOS PARA EL CHAT --- */
    .chat-wrapper {
        background-color: #f4f6f9; /* Fondo suave */
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        overflow: hidden;
        height: 80vh; /* Altura del chat (80% de la pantalla) */
        display: flex;
        flex-direction: column;
    }

    /* Cabecera del Chat */
    .chat-header {
        background: linear-gradient(135deg, #0d6efd, #0dcaf0); /* Degradado Azul */
        padding: 15px 20px;
        color: white;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .avatar-ia {
        width: 45px;
        height: 45px;
        background-color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: #0d6efd;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }

    .status-dot {
        height: 10px;
        width: 10px;
        background-color: #2ecc71; /* Verde online */
        border-radius: 50%;
        display: inline-block;
        box-shadow: 0 0 5px #2ecc71;
    }

    /* √Årea de Mensajes */
    .chat-box {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background-image: radial-gradient(#dee2e6 1px, transparent 1px);
        background-size: 20px 20px; /* Patr√≥n de puntos sutil */
    }

    /* Burbujas de Mensaje */
    .message-row {
        display: flex;
        margin-bottom: 20px;
        align-items: flex-end;
    }

    .message-row.user {
        justify-content: flex-end; /* Usuario a la derecha */
    }

    .message-bubble {
        max-width: 70%;
        padding: 12px 18px;
        border-radius: 18px;
        font-size: 0.95rem;
        line-height: 1.5;
        position: relative;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    /* Estilo Burbuja IA */
    .message-row.ia .message-bubble {
        background-color: #ffffff;
        color: #333;
        border-bottom-left-radius: 4px; /* Esquina cuadrada */
    }

    /* Estilo Burbuja Usuario */
    .message-row.user .message-bubble {
        background-color: #0d6efd; /* Azul Bootstrap */
        color: white;
        border-bottom-right-radius: 4px; /* Esquina cuadrada */
    }

    .message-avatar {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        margin: 0 10px;
    }

    /* Animaci√≥n de "Escribiendo..." */
    .typing-indicator span {
        display: inline-block;
        width: 6px;
        height: 6px;
        background-color: #aaa;
        border-radius: 50%;
        animation: typing 1.4s infinite ease-in-out both;
        margin: 0 2px;
    }
    
    .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
    .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes typing {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1); }
    }

    /* √Årea de Input */
    .chat-input-area {
        background-color: white;
        padding: 15px;
        border-top: 1px solid #e9ecef;
    }

    .input-group-custom {
        background-color: #f8f9fa;
        border-radius: 30px;
        padding: 5px 10px;
        border: 1px solid #ced4da;
        display: flex;
        align-items: center;
    }

    .input-group-custom input {
        border: none;
        background: transparent;
        box-shadow: none;
    }
    .input-group-custom input:focus {
        outline: none;
        background: transparent;
    }

    /* Scrollbar bonito */
    .chat-box::-webkit-scrollbar {
        width: 6px;
    }
    .chat-box::-webkit-scrollbar-thumb {
        background-color: #adb5bd;
        border-radius: 10px;
    }
</style>

<div class="container mt-4">
    <div class="chat-wrapper">
        
        <div class="chat-header">
            <div class="avatar-ia">
                <i class="bi bi-robot"></i> </div>
            <div>
                <h5 class="mb-0 fw-bold">Gemini SIDPOL 2.5</h5>
                <small><span class="status-dot"></span> En l√≠nea | Conectado a MongoDB</small>
            </div>
        </div>

        <div class="chat-box" id="chatBox">
            
            <div class="message-row ia">
                <div class="message-avatar bg-white border">ü§ñ</div>
                <div class="message-bubble">
                    ¬°Hola! Soy tu analista de seguridad virtual. 
                    <br><strong>Puedo responder preguntas sobre:</strong>
                    <ul class="mb-0 ps-3 mt-1">
                        <li>Estad√≠sticas de delitos por a√±o.</li>
                        <li>Ranking de departamentos peligrosos.</li>
                        <li>Tendencias de Extorsi√≥n o Sicariato.</li>
                    </ul>
                </div>
            </div>

            {% for msg in historial %}
                {% if msg.rol == 'usuario' %}
                    <div class="message-row user">
                        <div class="message-bubble">
                            {{ msg.texto }}
                        </div>
                        <div class="message-avatar bg-primary text-white">
                            <i class="bi bi-person-fill"></i>
                        </div>
                    </div>
                {% else %}
                    <div class="message-row ia">
                        <div class="message-avatar bg-white border text-primary">
                            <i class="bi bi-robot"></i>
                        </div>
                        <div class="message-bubble">
                            {{ msg.texto | safe }}
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
            
            <div class="message-row ia d-none" id="loadingBubble">
                <div class="message-avatar bg-white border text-primary">
                    <i class="bi bi-robot"></i>
                </div>
                <div class="message-bubble">
                    <div class="typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            </div>

        </div>

        <div class="chat-input-area">
            <form method="post" id="chatForm">
                <div class="input-group-custom">
                    <input type="text" name="mensaje" class="form-control" placeholder="Escribe tu consulta aqu√≠..." required autocomplete="off" id="userMsg">
                    <button class="btn btn-primary rounded-circle ms-2" type="submit" style="width: 45px; height: 45px;">
                        <i class="bi bi-send-fill"></i>
                    </button>
                </div>
            </form>
        </div>

    </div>
</div>

<script>
    const chatBox = document.getElementById('chatBox');
    const form = document.getElementById('chatForm');
    const loadingBubble = document.getElementById('loadingBubble');
    const inputField = document.getElementById('userMsg');

    // Funci√≥n para bajar el scroll
    function scrollToBottom() {
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Scroll al cargar la p√°gina
    document.addEventListener("DOMContentLoaded", scrollToBottom);

    // Efecto "Enviando..."
    form.addEventListener('submit', function() {
        // 1. Mostrar la burbuja de "Escribiendo..."
        loadingBubble.classList.remove('d-none');
        scrollToBottom();
        
        // (El formulario se env√≠a y recarga la p√°gina, pero esto da feedback visual inmediato)
    });
</script>

{% endblock %}