{% extends "base.html" %}

{% block title %}Radar de Riesgo - SIDPOL{% endblock %}

{% block content %}
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

<div class="container-fluid mt-4">
    
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h2 class="fw-bold text-dark">
                <i class="bi bi-bullseye text-danger"></i> Radar de Riesgo Criminal (IA)
            </h2>
            <p class="text-muted">
                Clasificación automática de departamentos utilizando el algoritmo <strong>K-Means</strong>.
            </p>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-4 mb-3">
            <div class="card border-start border-success border-5 shadow h-100">
                <div class="card-body text-center">
                    <div class="text-success text-uppercase fw-bold mb-1">Riesgo Bajo</div>
                    <div class="h1 mb-0 fw-bold text-gray-800">{{ stats.bajo }}</div>
                    <small class="text-muted">Departamentos</small>
                </div>
            </div>
        </div>

        <div class="col-md-4 mb-3">
            <div class="card border-start border-warning border-5 shadow h-100">
                <div class="card-body text-center">
                    <div class="text-warning text-uppercase fw-bold mb-1">Riesgo Medio</div>
                    <div class="h1 mb-0 fw-bold text-gray-800">{{ stats.medio }}</div>
                    <small class="text-muted">Departamentos</small>
                </div>
            </div>
        </div>

        <div class="col-md-4 mb-3">
            <div class="card border-start border-danger border-5 shadow h-100">
                <div class="card-body text-center">
                    <div class="text-danger text-uppercase fw-bold mb-1">Zona Crítica</div>
                    <div class="h1 mb-0 fw-bold text-gray-800">{{ stats.alto }}</div>
                    <small class="text-muted">Departamentos (Hotspots)</small>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-lg mb-4">
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between bg-white">
            <h6 class="m-0 font-weight-bold text-primary">Distribución de Clusters (Volumen Delictivo)</h6>
        </div>
        <div class="card-body">
            <div id="clusterChart" style="width:100%; height:600px;"></div>
        </div>
        <div class="card-footer text-muted small">
            <i class="bi bi-info-circle"></i> <strong>Interpretación:</strong> 
            El tamaño de cada burbuja representa la cantidad de denuncias. 
            El algoritmo agrupa matemáticamente las regiones con comportamientos similares.
        </div>
    </div>
</div>

<script>
    // 1. Recibir datos desde Flask (convertidos a JSON)
    const rawData = {{ data | tojson }};

    // 2. Organizar datos por series para Plotly
    const clusters = {
        0: { x: [], y: [], text: [], name: 'Riesgo Bajo', color: '#28a745' },    // Verde
        1: { x: [], y: [], text: [], name: 'Riesgo Medio', color: '#ffc107' },   // Amarillo
        2: { x: [], y: [], text: [], name: 'Riesgo Crítico', color: '#dc3545' }  // Rojo
    };

    rawData.forEach(d => {
        // Eje X: Cantidad de Delitos
        // Eje Y: Valor aleatorio (Jitter) para que no se superpongan visualmente
        clusters[d.cluster].x.push(d.total);
        clusters[d.cluster].y.push(Math.random() * 5 + d.cluster * 2); 
        
        // Texto flotante (Hover)
        const info = `<b>${d.departamento}</b><br>Denuncias: ${d.total.toLocaleString()}<br>Nivel: ${d.etiqueta}`;
        clusters[d.cluster].text.push(info);
    });

    // 3. Crear las trazas (Series)
    const traces = [];
    Object.keys(clusters).forEach(key => {
        const c = clusters[key];
        traces.push({
            x: c.x,
            y: c.y,
            text: c.text,
            mode: 'markers',
            name: c.name,
            marker: {
                // Tamaño dinámico logarítmico para que Lima no tape a los demás
                size: c.x.map(val => Math.max(15, Math.sqrt(val)/4)), 
                sizemode: 'area',
                color: c.color,
                opacity: 0.8,
                line: { width: 1, color: 'white' }
            },
            type: 'scatter',
            hovertemplate: '%{text}<extra></extra>' // Limpia el tooltip
        });
    });

    // 4. Configuración del Diseño
    const layout = {
        title: { text: '' },
        xaxis: { 
            title: 'Volumen Total de Denuncias (Escala Real)',
            gridcolor: '#f0f0f0'
        },
        yaxis: { 
            showgrid: false, 
            zeroline: false, 
            showticklabels: false, // Ocultamos el eje Y porque es artificial
            visible: false
        },
        hovermode: 'closest',
        plot_bgcolor: '#ffffff',
        paper_bgcolor: '#ffffff',
        legend: { orientation: 'h', y: -0.1 } // Leyenda abajo horizontal
    };

    // 5. Renderizar
    Plotly.newPlot('clusterChart', traces, layout, {responsive: true});
</script>
{% endblock %}