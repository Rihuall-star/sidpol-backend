<div id="chatbot-container">
    <button id="chatbot-trigger" onclick="toggleChat()">
        <i class="fas fa-comment-dots fa-lg"></i>
    </button>

    <div id="chatbot-window" class="card shadow-lg">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center py-2">
            <span><i class="fas fa-robot mr-2"></i>SIDPOL AI</span>
            <button class="btn btn-sm text-white" onclick="toggleChat()"><i class="fas fa-times"></i></button>
        </div>
        <div id="chat-messages" class="card-body bg-light" style="height: 350px; overflow-y: auto;">
            <div class="p-2 bg-white rounded mb-2 shadow-sm border">
                <p class="mb-0 text-dark small">Soy Gemini 2.5, tu analista de seguridad. ¿En qué ayudo?</p>
            </div>
        </div>
        <div class="card-footer p-2">
            <div class="input-group">
                <input type="text" id="chat-input" class="form-control form-control-sm" placeholder="..." onkeypress="handleEnter(event)">
                <div class="input-group-append">
                    <button class="btn btn-success btn-sm" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function toggleChat() {
        const w = document.getElementById('chatbot-window');
        w.style.display = (w.style.display === 'none' || w.style.display === '') ? 'block' : 'none';
    }
    function handleEnter(e) { if(e.key === 'Enter') sendMessage(); }
    
    function sendMessage() {
        const input = document.getElementById('chat-input');
        const msg = input.value.trim();
        if(!msg) return;

        const chatBody = document.getElementById('chat-messages');
        chatBody.innerHTML += `<div class="d-flex justify-content-end mb-2"><div class="p-2 bg-primary text-white rounded small" style="max-width:80%">${msg}</div></div>`;
        input.value = '';
        chatBody.scrollTop = chatBody.scrollHeight;

        fetch('/chat-ia', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: `mensaje=${encodeURIComponent(msg)}`
        })
        .then(r => r.json())
        .then(data => {
            const resp = data.respuesta || "Sin respuesta";
            chatBody.innerHTML += `<div class="d-flex justify-content-start mb-2"><div class="p-2 bg-white border rounded small text-dark" style="max-width:85%">${resp}</div></div>`;
            chatBody.scrollTop = chatBody.scrollHeight;
        });
    }
</script>