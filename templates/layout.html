<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>SIDPOL - Inteligencia Policial</title>

    <link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/startbootstrap-sb-admin-2@4.1.4/css/sb-admin-2.min.css" rel="stylesheet">

    <style>
        /* 2. ESTILOS PERSONALIZADOS DEL CHAT (Burbujas bonitas) */
        .chat-bubble-user {
            background-color: #4e73df; /* Azul SIDPOL */
            color: white;
            border-radius: 15px 15px 0px 15px;
            padding: 10px 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: inline-block;
            text-align: left;
        }
        .chat-bubble-bot {
            background-color: #f8f9fc; /* Blanco Humo */
            color: #3a3b45;
            border-left: 4px solid #1cc88a; /* Borde Verde Policial */
            border-radius: 5px 15px 15px 15px;
            padding: 10px 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: inline-block;
            text-align: left;
            width: 100%;
        }
        /* Animación suave */
        #chatbot-window { transition: all 0.3s ease-in-out; }
        .typing-indicator span {
            display: inline-block; width: 6px; height: 6px; background-color: #ccc; border-radius: 50%;
            animation: typing 1s infinite; margin: 0 2px;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
    </style>
</head>

<body id="page-top">

    <div id="wrapper">

        <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">
            <a class="sidebar-brand d-flex align-items-center justify-content-center" href="{{ url_for('index') }}">
                <div class="sidebar-brand-icon rotate-n-15"><i class="fas fa-shield-alt"></i></div>
                <div class="sidebar-brand-text mx-3">SIDPOL <sup>v1.0</sup></div>
            </a>
            <hr class="sidebar-divider my-0">
            <li class="nav-item">
                <a class="nav-link" href="{{ url_for('index') }}"><i class="fas fa-fw fa-tachometer-alt"></i><span>Dashboard</span></a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{{ url_for('riesgo_modalidad') }}"><i class="fas fa-fw fa-chart-area"></i><span>Agente Logístico</span></a>
            </li>
        </ul>

        <div id="content-wrapper" class="d-flex flex-column">
            <div id="content">
                <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">
                    <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3"><i class="fa fa-bars"></i></button>
                    <ul class="navbar-nav ml-auto">
                        <li class="nav-item dropdown no-arrow">
                            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-toggle="dropdown">
                                <span class="mr-2 d-none d-lg-inline text-gray-600 small">Oficial de Guardia</span>
                                <div class="img-profile rounded-circle bg-gray-200 d-flex align-items-center justify-content-center" style="width:32px;height:32px"><i class="fas fa-user"></i></div>
                            </a>
                        </li>
                    </ul>
                </nav>

                <div class="container-fluid">
                    {% block content %}{% endblock %}
                </div>
            </div>
            <footer class="sticky-footer bg-white">
                <div class="container my-auto"><div class="copyright text-center my-auto"><span>Copyright &copy; SIDPOL 2025</span></div></div>
            </footer>
        </div>
    </div>

    <div id="chatbot-container" style="position: fixed; bottom: 25px; right: 25px; z-index: 99999;">
        
        <button onclick="toggleChat()" style="width: 65px; height: 65px; border-radius: 50%; background: linear-gradient(45deg, #1cc88a, #13855c); border: none; color: white; box-shadow: 0 5px 15px rgba(28, 200, 138, 0.4); cursor: pointer; transition: transform 0.2s;">
            <i class="fas fa-robot fa-2x"></i>
        </button>

        <div id="chatbot-window" class="card shadow-lg" style="display: none; position: absolute; bottom: 80px; right: 0; width: 380px; height: 500px; border: none; border-radius: 15px; overflow: hidden; display: flex; flex-direction: column;">
            
            <div class="card-header text-white d-flex justify-content-between align-items-center py-3" style="background: linear-gradient(to right, #1cc88a, #4e73df);">
                <span style="font-weight: 600; letter-spacing: 0.5px;"><i class="fas fa-shield-alt mr-2"></i>INTELIGENCIA SIDPOL</span>
                <button class="btn btn-sm text-white-50 hover-white" onclick="toggleChat()"><i class="fas fa-times fa-lg"></i></button>
            </div>

            <div id="chat-messages" class="card-body bg-light" style="flex: 1; overflow-y: auto; padding: 15px;">
                <div class="d-flex justify-content-start mb-3">
                    <div class="chat-bubble-bot">
                        <small class="text-success font-weight-bold mb-1 d-block">Agente Gemini 2.5</small>
                        Hola. Tengo acceso a la base de denuncias 2018-2025 y a las proyecciones 2026. ¿Cuál es su consulta?
                    </div>
                </div>
            </div>

            <div class="card-footer bg-white p-3 border-top">
                <div class="input-group">
                    <input type="text" id="chat-input" class="form-control bg-light border-0 small" placeholder="Escriba su consulta..." onkeypress="handleEnter(event)" style="border-radius: 20px 0 0 20px; padding: 20px;">
                    <div class="input-group-append">
                        <button class="btn btn-primary" onclick="sendMessage()" style="border-radius: 0 20px 20px 0; padding-left: 15px; padding-right: 15px;">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function toggleChat() {
            const w = document.getElementById('chatbot-window');
            if (w.style.display === 'none' || w.style.display === '') {
                w.style.display = 'flex'; // Usamos flex para mantener el diseño vertical
                document.getElementById('chat-input').focus();
            } else {
                w.style.display = 'none';
            }
        }
        
        function handleEnter(e) { if(e.key === 'Enter') sendMessage(); }

        // Función para embellecer el texto de la IA (Markdown simple)
        function formatText(text) {
            // 1. Negritas: **texto** -> <b>texto</b>
            let formatted = text.replace(/\*\*(.*?)\*\*/g, '<b class="text-dark">$1</b>');
            // 2. Listas: * texto -> <br>• texto
            formatted = formatted.replace(/\* /g, '<br>• ');
            // 3. Saltos de línea
            formatted = formatted.replace(/\n/g, '<br>');
            return formatted;
        }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if(!msg) return;

            const chatBody = document.getElementById('chat-messages');
            
            // Mensaje Usuario (Azul)
            chatBody.innerHTML += `
                <div class="d-flex justify-content-end mb-3">
                    <div class="chat-bubble-user">
                        ${msg}
                    </div>
                </div>`;
            
            input.value = '';
            chatBody.scrollTop = chatBody.scrollHeight;

            // Indicador "Escribiendo..."
            const loadId = 'loading-' + Date.now();
            chatBody.innerHTML += `
                <div id="${loadId}" class="d-flex justify-content-start mb-3">
                    <div class="chat-bubble-bot" style="width: auto;">
                        <div class="typing-indicator"><span></span><span></span><span></span></div>
                    </div>
                </div>`;
            chatBody.scrollTop = chatBody.scrollHeight;

            // Petición al Servidor
            fetch('/chat-ia', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: `mensaje=${encodeURIComponent(msg)}`
            })
            .then(r => r.json())
            .then(data => {
                document.getElementById(loadId).remove();
                
                // Formatear respuesta (quitar asteriscos feos)
                const rawResp = data.respuesta || "Sin respuesta.";
                const prettyResp = formatText(rawResp);

                // Mensaje Bot (Blanco/Verde)
                chatBody.innerHTML += `
                    <div class="d-flex justify-content-start mb-3">
                        <div class="chat-bubble-bot">
                            ${prettyResp}
                        </div>
                    </div>`;
                chatBody.scrollTop = chatBody.scrollHeight;
            })
            .catch(err => {
                if(document.getElementById(loadId)) document.getElementById(loadId).remove();
                console.error(err);
            });
        }
    </script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.4.1/jquery.easing.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/startbootstrap-sb-admin-2@4.1.4/js/sb-admin-2.min.js"></script>

</body>
</html>