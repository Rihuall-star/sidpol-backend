{% extends "base.html" %}

{% block title %}Riesgo por modalidad{% endblock %}

{% block content %}

<h1 class="mb-4">Riesgo estimado de {{ modalidad }}</h1>

<p class="text-muted">
    Esta sección utiliza un modelo de <strong>RandomForestRegressor</strong> 
    (scikit-learn) para estimar el número de denuncias trimestrales 
    de la modalidad <strong>{{ modalidad }}</strong>, a partir de la serie histórica 2018–2025.
</p>

<div class="row mb-4">
    <!-- Gráfico histórico -->
    <div class="col-md-6">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <h5 class="card-title">Histórico trimestral (a nivel nacional)</h5>
                <canvas id="graficoRiesgo"></canvas>
                <p class="text-muted mt-2">
                    Evolución trimestral del total de denuncias registradas a nivel nacional
                    para la modalidad analizada.
                </p>
            </div>
        </div>
    </div>

    <!-- Formulario de simulación -->
    <div class="col-md-6">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <h5 class="card-title">Simular riesgo trimestral</h5>
                {% if anios_disp %}
                <form method="post">
                    <div class="mb-3">
                        <label for="anio" class="form-label">Año</label>
                        <select name="anio" id="anio" class="form-select" required>
                            {% for anio in anios_disp %}
                                <option value="{{ anio }}">{{ anio }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="trimestre" class="form-label">Trimestre</label>
                        <select name="trimestre" id="trimestre" class="form-select" required>
                            {% for tri in trimestres_disp %}
                                <option value="{{ tri }}">{{ tri }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="departamento" class="form-label">Departamento (contexto)</label>
                        <select name="departamento" id="departamento" class="form-select">
                            {% for d in dptos %}
                                <option value="{{ d }}">{{ d }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">
                            En esta versión del modelo el departamento se usa solo como contexto descriptivo.
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">Estimar denuncias</button>
                </form>
                {% else %}
                    <p class="text-danger">
                        No se encontraron datos históricos suficientes para entrenar el modelo.
                    </p>
                {% endif %}

                {% if prediccion is not none %}
                    <hr>
                    <h5>Resultado de la estimación</h5>
                    <p>
                        Para <strong>{{ entrada.trimestre }}</strong> del año 
                        <strong>{{ entrada.anio }}</strong>
                        en el contexto del departamento 
                        <strong>{{ entrada.departamento }}</strong>,
                        el modelo estima aproximadamente:
                    </p>
                    <p class="display-6">{{ prediccion }}</p>
                    <p class="text-muted">
                        denuncias de {{ modalidad }} en ese trimestre.
                    </p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    const ctxRiesgo = document.getElementById('graficoRiesgo');

    const etiquetasRiesgo = {{ labels | tojson }};
    const datosRiesgo = {{ valores | tojson }};

    new Chart(ctxRiesgo, {
        type: 'line',
        data: {
            labels: etiquetasRiesgo,
            datasets: [{
                label: 'Denuncias trimestrales de {{ modalidad }} (histórico)',
                data: datosRiesgo,
                borderWidth: 2,
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
</script>

{% endblock %}
